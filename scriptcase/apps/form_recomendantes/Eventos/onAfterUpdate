// ====================================================================
// Evento: onAfterUpdate
// Scriptcase: v9 | PHP 8.1
// Documentaci√≥n: https://www.scriptcase.net/docs/en_us/v9/manual/06-applications/05-form-application/18-form-events/
// Macros usados: (ninguno directo; llama al m√©todo crear_usuario_recomendante)
// Fuente: https://www.scriptcase.net/docs/en_us/v9/manual/14-macros/02-macros/
// ====================================================================
// NOTA: En formularios "Multiple Records", este evento puede ejecutarse al
//       cargar la p√°gina con datos vac√≠os. Por eso validamos id_recom y correo.
// ====================================================================

// VALIDACI√ìN CR√çTICA: Solo ejecutar si hay id_recom y correo v√°lidos
$id_recom_val = trim({id_recom});
$correo_val = trim({correo});

error_log("üíæ form_recomendantes onAfterUpdate: INICIO id_recom=$id_recom_val correo=$correo_val");

// Si no hay id_recom o est√° vac√≠o, NO hacer nada (es una carga, no un guardado)
if (empty($id_recom_val) || $id_recom_val === '' || $id_recom_val === '0' || $id_recom_val === 0) {
    error_log("üíæ form_recomendantes onAfterUpdate: SKIP - id_recom vac√≠o (no es un guardado real)");
    return;
}

// Si no hay correo, NO crear usuario (pero s√≠ es un guardado)
if (empty($correo_val) || $correo_val === '') {
    error_log("üíæ form_recomendantes onAfterUpdate: SKIP - correo vac√≠o, no se crea usuario");
    return;
}

// 1. Crear usuario, actualizar recomendantes (login_FK, cc_edit) y enviar correos
crear_usuario_recomendante($id_recom_val, {nombre}, {apellido_p}, {apellido_m}, $correo_val);

error_log("üíæ form_recomendantes onAfterUpdate: M√©todo crear_usuario ejecutado");

// 2. Marcar flag para mensaje de √©xito (opcional)
$_SESSION['form_recomendantes_guardado_exitoso'] = true;

// NO hacer sc_redir aqu√≠: si se redirige antes de que ScriptCase haga commit de la
// transacci√≥n del formulario, el UPDATE a recomendantes (login_FK, cc_edit) puede
// perderse (rollback). El usuario y el correo s√≠ se crean, pero la fila en
// recomendantes queda sin login_FK y cc_edit=1. Dejar que el form termine y muestre
// la pantalla; al recargar manualmente o volver al grid se ver√° cc_edit=0.

error_log("üíæ form_recomendantes onAfterUpdate: FIN");
