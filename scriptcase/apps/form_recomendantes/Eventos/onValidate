// ====================================================================
// Evento: onValidate
// Scriptcase: v9 | PHP 8.1
// Documentaci칩n: https://www.scriptcase.net/docs/en_us/v9/manual/06-applications/05-form-application/18-form-events/08-onValidate
// Macros usados: sc_error_message, sc_lookup, sc_sql_injection
// Fuente: https://www.scriptcase.net/docs/en_us/v9/manual/14-macros/02-macros/
// ====================================================================
// NOTA: Se ejecuta al enviar el formulario (Add/Change/Delete). Si sc_error_message()
//       se ejecuta, se cancela el env칤o del formulario.
// ====================================================================

error_log("游댒 form_recomendantes onValidate: INICIO - Validando campos obligatorios");

// Validar que TODOS los campos est칠n llenos
$nombre     = trim({nombre});
$apellido_p = trim({apellido_p});
$apellido_m = trim({apellido_m});
$correo     = trim({correo});

// Solo validar si es un UPDATE (tiene id_recom) - evitar validaci칩n en cargas vac칤as
$id_recom_val = trim({id_recom});
if (empty($id_recom_val)) {
    error_log("游댒 form_recomendantes onValidate: SKIP - id_recom vac칤o (carga de p치gina)");
    return;
}

// Validar campos obligatorios
if (empty($nombre)) {
    sc_error_message("El campo Nombre es obligatorio. Por favor complete todos los datos del recomendante.");
    return;
}

if (empty($apellido_p)) {
    sc_error_message("El campo Apellido Paterno es obligatorio. Por favor complete todos los datos del recomendante.");
    return;
}

// Apellido materno opcional (extranjeros u otros pueden no tenerlo)

if (empty($correo)) {
    sc_error_message("El campo Correo es obligatorio. Por favor complete todos los datos del recomendante. Una vez guardado no podr치 modificarse.");
    return;
}

// Validar formato de correo electr칩nico
if (!filter_var($correo, FILTER_VALIDATE_EMAIL)) {
    sc_error_message("El correo electr칩nico ingresado no es v치lido. Por favor ingrese un correo con formato correcto (ejemplo: nombre@dominio.com).");
    return;
}

// Nota: No validamos correo duplicado. Si ya existe en sec_asp_users, crear_usuario_recomendante
// vincula (login_FK, cc_edit=0) y no crea otra cuenta. El recomendante ver치 todos los casos
// v칤a asp_recomendantes WHERE id_recom_FK = [id_recom].

// Bloquear si ya tiene usuario creado (cc_edit=0). OnBeforeUpdate no corre en Editable Grid.
$cc_edit_val = trim({cc_edit});
if ($cc_edit_val == 0 || $cc_edit_val === '0' || $cc_edit_val === 'N') {
    sc_error_message("Este recomendante ya tiene usuario de acceso para subir cartas. No se puede editar.");
    return;
}

error_log("游댒 form_recomendantes onValidate: FIN - Todos los campos v치lidos");
