// Crear usuario en sec_asp_users para el recomendante, asignar grupo 7 y enviar correo con datos de acceso.
// Llamar desde onAfterUpdate: crear_usuario_recomendante({id_recom}, {nombre}, {apellido_p}, {apellido_m}, {correo});
// Destino del correo (por ahora): anibal.sanchez@inecol.mx
// Campo de control: cc_edit = 0/'N' tras crear usuario (bloquea nueva edición).

error_log("crear_usuario_recomendante: INICIO id_recom=$id_recom correo=$correo");

$nombre     = trim($nombre);
$apellido_p = trim($apellido_p);
$apellido_m = trim($apellido_m);
$correo     = trim($correo);

if ($correo === '') {
    error_log("crear_usuario_recomendante: ERROR correo vacío");
    sc_error_message("El correo del recomendante es obligatorio para crear el usuario de acceso.");
    return;
}

// No crear si ya se marcó como no editable (cc_edit = 0 o 'N')
sc_lookup(rs_cc, "SELECT cc_edit FROM recomendantes WHERE id_recom = " . sc_sql_injection($id_recom));
$cc_edit = isset({rs_cc[0][0]}) ? trim({rs_cc[0][0]}) : 1;
error_log("crear_usuario_recomendante: cc_edit=$cc_edit para id_recom=$id_recom");
if ($cc_edit == 0 || $cc_edit === 'N') {
    error_log("crear_usuario_recomendante: SALIDA ya tiene usuario (cc_edit=0)");
    return; // Ya tiene usuario creado, no volver a crear
}

$login = $correo;

// ¿Ya existe el login en sec_asp_users? (p. ej. mismo correo usado en otro recomendante)
sc_lookup(rs_usr, "SELECT login FROM sec_asp_users WHERE login = " . sc_sql_injection($login));
if (isset({rs_usr[0][0]})) {
    // Solo asignar a grupo 7, vincular recomendante y bloquear edición
    $sql_grp = "INSERT IGNORE INTO sec_asp_users_groups (login, group_id) VALUES (" . sc_sql_injection($login) . ", 7)";
    sc_exec_sql($sql_grp);
    $upd = "UPDATE recomendantes SET login_FK = " . sc_sql_injection($login) . ", cc_edit = 0 WHERE id_recom = " . sc_sql_injection($id_recom);
    sc_exec_sql($upd);
    return;
}

// Generar contraseña aleatoria (8 caracteres)
$chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
$pswd = '';
for ($i = 0; $i < 8; $i++) {
    $pswd .= $chars[mt_rand(0, strlen($chars) - 1)];
}

// INSERT sec_asp_users (campos mínimos como en el sistema)
$ins_user = "INSERT INTO sec_asp_users (login, pswd, name, apat, amat, email, active, priv_admin, fecha_alta) VALUES ("
    . sc_sql_injection($login) . ", "
    . sc_sql_injection($pswd) . ", "
    . sc_sql_injection($nombre) . ", "
    . sc_sql_injection($apellido_p) . ", "
    . sc_sql_injection($apellido_m) . ", "
    . sc_sql_injection($correo) . ", "
    . "'Y', 'N', NOW())";
sc_exec_sql($ins_user);

// INSERT sec_asp_users_groups → group_id = 7 (recomendantes que suben cartas)
$ins_grp = "INSERT INTO sec_asp_users_groups (login, group_id) VALUES (" . sc_sql_injection($login) . ", 7)";
sc_exec_sql($ins_grp);

// Vincular recomendante con el usuario y marcar como no editable (cc_edit = 0)
$upd_recom = "UPDATE recomendantes SET login_FK = " . sc_sql_injection($login) . ", cc_edit = 0 WHERE id_recom = " . sc_sql_injection($id_recom);
sc_exec_sql($upd_recom);

// Enviar correo con datos de acceso (por ahora a anibal.sanchez@inecol.mx)
$mail_to = 'anibal.sanchez@inecol.mx';
$mail_message = 'Se ha creado usuario de acceso para recomendante (cartas):<br><br>'
    . '<strong>Recomendante:</strong> ' . htmlspecialchars($nombre . ' ' . $apellido_p . ' ' . $apellido_m) . '<br>'
    . '<strong>Correo:</strong> ' . htmlspecialchars($correo) . '<br><br>'
    . '<strong>Datos de acceso para el recomendante:</strong><br>'
    . 'Usuario: <strong>' . htmlspecialchars($login) . '</strong><br>'
    . 'Contraseña: <strong>' . htmlspecialchars($pswd) . '</strong><br><br>'
    . 'Con estos datos el recomendante puede iniciar sesión y subir sus cartas.';

$asunto = 'INECOL. Usuario de acceso creado para recomendante (cartas)';

try {
    $mail_smtp_server    = 'smtp.gmail.com';
    $mail_smtp_user      = 'sce.posgrado@gmail.com';
    $mail_smtp_pass      = 'fqczuzvfomytleda';
    $mail_from           = 'sce.posgrado@gmail.com';
    $mail_copies         = '';
    $mail_format         = 'H';
    $mail_tp_copies      = 'CCC';
    $mail_port           = '465';
    $mail_tp_connection  = 'S';

    @sc_mail_send($mail_smtp_server, $mail_smtp_user, $mail_smtp_pass, $mail_from,
        $mail_to, $asunto, $mail_message, $mail_format, $mail_copies, $mail_tp_copies,
        $mail_port, $mail_tp_connection);
} catch (Exception $e) {
    error_log("form_recomendantes: Error enviando correo usuario recomendante: " . $e->getMessage());
}
